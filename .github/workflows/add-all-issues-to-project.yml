name: Add All Issues to Project

on:
  workflow_dispatch:
    inputs:
      start_issue:
        description: 'Start issue number (default: 80)'
        required: false
        default: '80'
      end_issue:
        description: 'End issue number (default: 113)'
        required: false
        default: '113'

env:
  PROJECT_NUMBER: 2

jobs:
  add_issues:
    runs-on: ubuntu-latest
    name: Add Issues to Project Board
    steps:
      - name: Add issues to project
        env:
          GITHUB_TOKEN: ${{ secrets.PROJECT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸš€ Adding issues ${{ github.event.inputs.start_issue || '80' }} to ${{ github.event.inputs.end_issue || '113' }} to project #${{ env.PROJECT_NUMBER }}"
          
          # Get project ID
          PROJECT_DATA=$(gh api graphql -f query='
            query($owner: String!, $number: Int!) {
              user(login: $owner) {
                projectV2(number: $number) {
                  id
                  fields(first: 20) {
                    nodes {
                      ... on ProjectV2SingleSelectField {
                        id
                        name
                        options {
                          id
                          name
                        }
                      }
                    }
                  }
                }
              }
            }' -f owner=${{ github.repository_owner }} -F number=${{ env.PROJECT_NUMBER }})
          
          PROJECT_ID=$(echo $PROJECT_DATA | jq -r '.data.user.projectV2.id')
          
          if [ "$PROJECT_ID" = "null" ]; then
            echo "âŒ Could not find project #${{ env.PROJECT_NUMBER }}"
            exit 1
          fi
          
          echo "âœ… Found project ID: $PROJECT_ID"
          
          # Get backlog status option ID
          BACKLOG_ID=$(echo $PROJECT_DATA | jq -r '.data.user.projectV2.fields.nodes[] | select(.name == "Status") | .options[] | select(.name == "Backlog") | .id')
          STATUS_FIELD_ID=$(echo $PROJECT_DATA | jq -r '.data.user.projectV2.fields.nodes[] | select(.name == "Status") | .id')
          
          echo "ğŸ“Š Status field ID: $STATUS_FIELD_ID"
          echo "ğŸ“‹ Backlog option ID: $BACKLOG_ID"
          
          # Add issues
          START_ISSUE=${{ github.event.inputs.start_issue || '80' }}
          END_ISSUE=${{ github.event.inputs.end_issue || '113' }}
          ADDED_COUNT=0
          
          for issue_num in $(seq $START_ISSUE $END_ISSUE); do
            echo "Processing issue #$issue_num..."
            
            # Get issue node ID
            ISSUE_DATA=$(gh api repos/${{ github.repository }} issues/$issue_num 2>/dev/null || echo '{"node_id": null}')
            ISSUE_NODE_ID=$(echo $ISSUE_DATA | jq -r '.node_id')
            
            if [ "$ISSUE_NODE_ID" = "null" ]; then
              echo "âš ï¸  Issue #$issue_num not found"
              continue
            fi
            
            # Add issue to project
            ADD_RESULT=$(gh api graphql -f query='
              mutation($projectId: ID!, $contentId: ID!) {
                addProjectV2ItemByContentId(input: {
                  projectId: $projectId,
                  contentId: $contentId
                }) {
                  item {
                    id
                  }
                }
              }' -f projectId=$PROJECT_ID -f contentId=$ISSUE_NODE_ID 2>/dev/null || echo '{"data": {"addProjectV2ItemByContentId": {"item": null}}}')
            
            ITEM_ID=$(echo $ADD_RESULT | jq -r '.data.addProjectV2ItemByContentId.item.id')
            
            if [ "$ITEM_ID" != "null" ]; then
              echo "âœ… Added issue #$issue_num to project"
              ADDED_COUNT=$((ADDED_COUNT + 1))
              
              # Set to Backlog status if we have the field IDs
              if [ "$STATUS_FIELD_ID" != "null" ] && [ "$BACKLOG_ID" != "null" ]; then
                gh api graphql -f query='
                  mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: ProjectV2FieldValue!) {
                    updateProjectV2ItemFieldValue(input: {
                      projectId: $projectId,
                      itemId: $itemId,
                      fieldId: $fieldId,
                      value: $value
                    }) {
                      projectV2Item {
                        id
                      }
                    }
                  }' -f projectId=$PROJECT_ID -f itemId=$ITEM_ID -f fieldId=$STATUS_FIELD_ID -f value="{\"singleSelectOptionId\":\"$BACKLOG_ID\"}" > /dev/null 2>&1
                echo "ğŸ“‹ Set issue #$issue_num to Backlog status"
              fi
            else
              echo "âŒ Failed to add issue #$issue_num (may already be in project)"
            fi
            
            # Small delay to avoid rate limits
            sleep 0.5
          done
          
          echo ""
          echo "ğŸ‰ Successfully processed issues. Added $ADDED_COUNT new issues to the project."
          echo "ğŸ“ Visit your project: https://github.com/users/${{ github.repository_owner }}/projects/${{ env.PROJECT_NUMBER }}"