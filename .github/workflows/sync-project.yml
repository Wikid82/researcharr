---
name: Sync Issues to Project

on:
  workflow_dispatch:
    inputs:
      sync_existing:
        description: "Sync existing issues and PRs to project"
        type: boolean
        required: true
        default: true

env:
  PROJECT_NUMBER: 2  # Update this with your actual project number

jobs:
  sync_issues:
    runs-on: ubuntu-latest
    name: Sync Existing Issues and PRs
    if: ${{ github.event.inputs.sync_existing == 'true' }}
    steps:
      - name: Get project data
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ORGANIZATION: ${{ github.repository_owner }}
          PROJECT_NUMBER: ${{ env.PROJECT_NUMBER }}
        run: |
          gh api graphql -f query='
            query($org: String!, $number: Int!) {
              organization(login: $org) {
                projectV2(number: $number) {
                  id
                  fields(first:20) {
                    nodes {
                      ... on ProjectV2Field {
                        id
                        name
                      }
                      ... on ProjectV2SingleSelectField {
                        id
                        name
                        options {
                          id
                          name
                        }
                      }
                    }
                  }
                }
              }
            }' -f org=$ORGANIZATION -F number=$PROJECT_NUMBER > project_data.json

          PROJECT_ID=$(jq -r '.data.organization.projectV2.id // empty' project_data.json)
          if [ -z "$PROJECT_ID" ]; then
            echo "Could not find project  #${PROJECT_NUMBER} in organization ${ORGANIZATION}; aborting sync."
            exit 0
          fi
          echo "PROJECT_ID=$PROJECT_ID" >> $GITHUB_ENV

      - name: Get all issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues --paginate \
            -q '.[] | select(.pull_request == null) | {id: .node_id, number: .number, state: .state, assignee: .assignee}' \
            > issues.json

      - name: Get all pull requests
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/pulls --paginate -q '.[] | {id: .node_id, number: .number, state: .state, draft: .draft, merged: .merged}' > prs.json

      - name: Add issues to project
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          while IFS= read -r issue; do
            ISSUE_ID=$(echo $issue | jq -r '.id')
            ISSUE_NUMBER=$(echo $issue | jq -r '.number')
            ISSUE_STATE=$(echo $issue | jq -r '.state')
            ASSIGNEE=$(echo $issue | jq -r '.assignee')

            echo "Adding issue  #$ISSUE_NUMBER to project..."

            # Add to project
            ITEM_RESPONSE=$(gh api graphql -f query='
              mutation($project:ID!, $contentId:ID!) {
                addProjectV2ItemByContentId(input: {projectId: $project, contentId: $contentId}) {
                  item {
                    id
                  }
                }
              }' -f project=$PROJECT_ID -f contentId=$ISSUE_ID)

            ITEM_ID=$(echo $ITEM_RESPONSE | jq -r '.data.addProjectV2ItemByContentId.item.id')

            # Set status based on issue state and assignment
            STATUS_FIELD_ID=$(jq -r '.data.organization.projectV2.fields.nodes[] | select(.name == "Status") | .id // empty' project_data.json)
            if [ -z "$STATUS_FIELD_ID" ]; then
              echo "Status field not found in project data; skipping status update for issue  #$ISSUE_NUMBER"
              continue
            fi

            if [ "$ISSUE_STATE" == "closed" ]; then
              STATUS="Done"
            elif [ "$ASSIGNEE" != "null" ]; then
              STATUS="In Progress"
            else
              STATUS="Backlog"
            fi

            STATUS_OPTION_ID=$(jq -r '.data.organization.projectV2.fields.nodes[] | select(.name == "Status") | .options[] | select(.name == "'$STATUS'") | .id // empty' project_data.json)
            if [ -z "$STATUS_OPTION_ID" ]; then
              echo "Status option '$STATUS' not found for project; skipping status update for issue  #$ISSUE_NUMBER"
            else

              # Update status
              gh api graphql -f query='
              mutation($project:ID!, $item:ID!, $field:ID!, $value:String!) {
                updateProjectV2ItemFieldValue(input: {
                  projectId: $project
                  itemId: $item
                  fieldId: $field
                  value: {
                    singleSelectOptionId: $value
                  }
                }) {
                  projectV2Item {
                    id
                  }
                }
              }' -f project=$PROJECT_ID -f item=$ITEM_ID -f field=$STATUS_FIELD_ID -f value=$STATUS_OPTION_ID

              echo "Issue  #$ISSUE_NUMBER added with status: $STATUS"
            fi

          done < <(cat issues.json | jq -c '.')

      - name: Add pull requests to project
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          while IFS= read -r pr; do
            PR_ID=$(echo $pr | jq -r '.id')
            PR_NUMBER=$(echo $pr | jq -r '.number')
            PR_STATE=$(echo $pr | jq -r '.state')
            IS_DRAFT=$(echo $pr | jq -r '.draft')
            IS_MERGED=$(echo $pr | jq -r '.merged')

            echo "Adding PR  #$PR_NUMBER to project..."

            # Add to project
            ITEM_RESPONSE=$(gh api graphql -f query='
              mutation($project:ID!, $contentId:ID!) {
                addProjectV2ItemByContentId(input: {projectId: $project, contentId: $contentId}) {
                  item {
                    id
                  }
                }
              }' -f project=$PROJECT_ID -f contentId=$PR_ID)

            ITEM_ID=$(echo $ITEM_RESPONSE | jq -r '.data.addProjectV2ItemByContentId.item.id')

            # Set status based on PR state
            STATUS_FIELD_ID=$(jq -r '.data.organization.projectV2.fields.nodes[] | select(.name == "Status") | .id // empty' project_data.json)
            if [ -z "$STATUS_FIELD_ID" ]; then
              echo "Status field not found in project data; skipping status update for PR  #$PR_NUMBER"
              continue
            fi

            if [ "$IS_MERGED" == "true" ] || [ "$PR_STATE" == "closed" ]; then
              STATUS="Done"
            elif [ "$IS_DRAFT" == "true" ]; then
              STATUS="In Progress"
            else
              STATUS="Review"
            fi

            STATUS_OPTION_ID=$(jq -r '.data.organization.projectV2.fields.nodes[] | select(.name == "Status") | .options[] | select(.name == "'$STATUS'") | .id // empty' project_data.json)
            if [ -z "$STATUS_OPTION_ID" ]; then
              echo "Status option '$STATUS' not found for project; skipping status update for PR  #$PR_NUMBER"
            else
              # Update status
              gh api graphql -f query='
              mutation($project:ID!, $item:ID!, $field:ID!, $value:String!) {
                updateProjectV2ItemFieldValue(input: {
                  projectId: $project
                  itemId: $item
                  fieldId: $field
                  value: {
                    singleSelectOptionId: $value
                  }
                }) {
                  projectV2Item {
                    id
                  }
                }
              }' -f project=$PROJECT_ID -f item=$ITEM_ID -f field=$STATUS_FIELD_ID -f value=$STATUS_OPTION_ID

              echo "PR  #$PR_NUMBER added with status: $STATUS"
            fi

          done < <(cat prs.json | jq -c '.')
