{% extends 'base.html' %}

{% block content %}
  <div class="container main-content">
    <h1>Tasks</h1>
    <p>Scheduled and background tasks are listed here. You can view previous job runs, trigger a job immediately, and configure how many entries to display.</p>

    <section id="tasks-controls" style="margin-top:12px;display:flex;gap:12px;align-items:center;">
      <div>
        <label>Show
          <input id="show-count" type="number" min="1" max="500" style="width:80px;margin-left:6px;"/>
        </label>
        <button id="save-show-count" class="btn">Save</button>
      </div>
      <div>
        <button id="trigger-job" class="btn primary">Trigger job now</button>
        <span id="trigger-status" style="margin-left:8px;color:#666"></span>
      </div>
      <div style="margin-left:auto;display:flex;align-items:center;gap:8px;">
        <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="filter-failed"> Show failures only</label>
      </div>
    </section>

    <script>
    (function(){
      const container = document.getElementById('tasks-table-container');
      const showCountEl = document.getElementById('show-count');
      const saveBtn = document.getElementById('save-show-count');
      const triggerBtn = document.getElementById('trigger-job');
      const triggerStatus = document.getElementById('trigger-status');
      const pagerPrev = document.getElementById('pager-prev');
      const pagerNext = document.getElementById('pager-next');
      const pagerInfo = document.getElementById('pager-info');
      const filterFailed = document.getElementById('filter-failed');

      let offset = 0;
      let total = 0;

      async function loadSettings(){
        try{
          const r = await fetch('/api/tasks/settings');
          if (r.ok){
            const j = await r.json();
            showCountEl.value = j.show_count || 20;
          }
        }catch(e){/* ignore */}
      }

      function makeRow(r){
        const tpl = document.getElementById('task-row-tpl');
        const node = tpl.content.cloneNode(true);
        const start = node.querySelector('.task-start');
        const result = node.querySelector('.task-result');
        const log = node.querySelector('.task-log');
        const expand = node.querySelector('.expand-log');
        start.textContent = r.start || '(unknown start)';
        let statusText = 'Unknown';
        const failed = (r.returncode !== null && r.returncode !== 0) || (!!r.has_stderr && r.has_stderr === true);
        if (r.returncode !== null){
          statusText = r.returncode === 0 ? 'Success' : 'Failed (rc=' + r.returncode + ')';
        } else if (r.has_stderr){
          statusText = 'Possible failure (stderr present)';
        }
        result.textContent = statusText;
        if (failed){ result.classList.add('text-danger'); }
        log.textContent = r.lines ? r.lines.join('\n') : '';

        expand.addEventListener('click', function(){
          if (log.style.display === 'none'){
            log.style.display = 'block';
            expand.textContent = 'Hide log';
          } else {
            log.style.display = 'none';
            expand.textContent = 'Show log';
          }
        });

        // add actions (download log, retry)
        const actionsWrap = document.createElement('div');
        actionsWrap.style.display = 'flex';
        actionsWrap.style.gap = '6px';
        const download = document.createElement('button');
        download.className = 'btn ghost';
        download.textContent = 'Download log';
        download.addEventListener('click', function(){
          try{
            const blob = new Blob([log.textContent], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = (r.start || 'run') + '.log';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
          }catch(e){/* ignore */}
        });

        const retry = document.createElement('button');
        retry.className = 'btn';
        retry.textContent = 'Retry';
        retry.addEventListener('click', async function(){
          retry.disabled = true;
          retry.textContent = 'Triggering…';
          try{
            const res = await fetch('/api/tasks/trigger', {method:'POST'});
            if (res.ok){
              const j = await res.json();
              if (j.result === 'triggered'){
                retry.textContent = 'Triggered';
                setTimeout(()=> retry.textContent = 'Retry', 1500);
                setTimeout(()=> loadRuns(), 2000);
              } else {
                retry.textContent = 'Failed';
              }
            } else {
              retry.textContent = 'Failed';
            }
          }catch(e){
            retry.textContent = 'Failed';
          }finally{
            retry.disabled = false;
          }
        });

        actionsWrap.appendChild(download);
        actionsWrap.appendChild(retry);

        // append actions into the card's right-side actions area
        const right = node.querySelector('div > div:last-child');
        if (right){ right.appendChild(actionsWrap); }

        return node;
      }

      function renderRuns(runs){
        container.innerHTML = '';
        if (!runs || !runs.length){
          container.appendChild(document.createElement('div')).textContent = 'No runs found.';
          pagerInfo.textContent = '';
          return;
        }
        runs.forEach(r => {
          const row = makeRow(r);
          container.appendChild(row);
        });
        const showingFrom = offset + 1;
        const showingTo = Math.min(offset + parseInt(showCountEl.value || '20', 10), total);
        pagerInfo.textContent = `Showing ${showingFrom}-${showingTo} of ${total}`;
      }

      async function loadRuns(){
        container.innerHTML = '<p class="muted">Loading recent runs…</p>';
        const limit = parseInt(showCountEl.value || '20', 10);
        try{
          const r = await fetch('/api/tasks?limit=' + encodeURIComponent(limit) + '&offset=' + encodeURIComponent(offset));
          if (!r.ok){
            container.innerHTML = '';
            container.appendChild(document.createElement('div')).textContent = 'Failed to load runs.';
            return;
          }
          const j = await r.json();
          total = j.total || 0;
          let runs = j.runs || [];
          if (filterFailed && filterFailed.checked){
            runs = runs.filter(rr => (rr.returncode !== null && rr.returncode !== 0) || (!!rr.has_stderr && rr.has_stderr === true));
          }
          renderRuns(runs);
          // pager buttons state
          pagerPrev.disabled = offset <= 0;
          pagerNext.disabled = offset + limit >= total;
        }catch(e){
          container.innerHTML = '';
          container.appendChild(document.createElement('div')).textContent = 'Failed to load runs.';
        }
      }

      saveBtn.addEventListener('click', async function(){
        const val = parseInt(showCountEl.value || '20', 10);
        try{
          const r = await fetch('/api/tasks/settings', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({show_count: val})});
          if (r.ok){
            triggerStatus.textContent = 'Saved';
            setTimeout(()=> triggerStatus.textContent = '', 1500);
            offset = 0;
            loadRuns();
          } else {
            triggerStatus.textContent = 'Save failed';
            setTimeout(()=> triggerStatus.textContent = '', 2000);
          }
        }catch(e){
          triggerStatus.textContent = 'Save failed';
          setTimeout(()=> triggerStatus.textContent = '', 2000);
        }
      });

      triggerBtn.addEventListener('click', async function(){
        triggerBtn.disabled = true;
        triggerStatus.textContent = 'Triggering…';
        try{
          const r = await fetch('/api/tasks/trigger', {method:'POST'});
          if (r.ok){
            const j = await r.json();
            if (j.result === 'triggered'){
              triggerStatus.textContent = 'Triggered';
              setTimeout(()=> triggerStatus.textContent = '', 2000);
              // refresh runs after a short delay to allow job to start
              setTimeout(loadRuns, 2000);
            } else {
              triggerStatus.textContent = 'Trigger failed';
            }
          } else {
            triggerStatus.textContent = 'Trigger failed';
          }
        }catch(e){
          triggerStatus.textContent = 'Trigger failed';
        }finally{
          triggerBtn.disabled = false;
        }
      });

      pagerPrev.addEventListener('click', function(){
        const limit = parseInt(showCountEl.value || '20', 10);
        offset = Math.max(0, offset - limit);
        loadRuns();
      });
      pagerNext.addEventListener('click', function(){
        const limit = parseInt(showCountEl.value || '20', 10);
        offset = offset + limit;
        loadRuns();
      });

      filterFailed.addEventListener('change', function(){ offset = 0; loadRuns(); });

      // Initial load
      loadSettings().then(loadRuns);
    })();
    </script>

    <section id="tasks-list" style="margin-top:18px;">
      <h2>Recent job runs</h2>
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div id="tasks-table-container">
          <p class="muted">Loading recent runs…</p>
        </div>
        <div id="tasks-pager" style="display:flex;gap:8px;align-items:center;">
          <button id="pager-prev" class="btn ghost">Prev</button>
          <span id="pager-info" class="muted">&nbsp;</span>
          <button id="pager-next" class="btn ghost">Next</button>
        </div>
      </div>
    </section>

    <template id="task-row-tpl">
      <div class="card task-row" style="padding:8px;margin-bottom:8px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <strong class="task-start"></strong>
            <div class="task-result muted"></div>
          </div>
          <div>
            <button class="btn ghost expand-log">Show log</button>
          </div>
        </div>
        <pre class="task-log" style="display:none;background:#111;color:#fff;padding:8px;border-radius:6px;margin-top:8px;white-space:pre-wrap;max-height:240px;overflow:auto"></pre>
      </div>
    </template>
  </div>
{% endblock %}
