name: Distroless CI (build, test, trivy, publish)

on:
  push:
    branches: [ main, development ]
    tags: [ 'v*', '*' ]
  pull_request:
    branches: [ main, development ]

permissions:
  contents: read
  packages: write

jobs:
  distroless-ci:
    name: Build distroless image, run tests, Trivy
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Set up QEMU and buildx
      uses: docker/setup-buildx-action@v2

    - name: Build builder stage image
      run: |
        docker build --target builder -f Dockerfile.distroless -t local/researcharr:builder .

    - name: Run mypy + pytest inside builder image
      env:
        # Include /install (where builder stage put runtime deps via --target)
        PYTHONPATH: /install:${{ github.workspace }}
      run: |
        # Ensure the builder image has mypy/pytest and typing stubs, and run
        # mypy/pytest with PYTHONPATH pointing at /install and the checked-out code
        docker run --rm --entrypoint "" -v "${{ github.workspace }}":/src -w /src local/researcharr:builder sh -lc "python -m pip install --upgrade pip && pip install mypy pytest types-PyYAML && PYTHONPATH=/install:/src mypy . && PYTHONPATH=/install:/src pytest tests/ --maxfail=1 -q"

    - name: Build final distroless image (loaded)
      uses: docker/build-push-action@v5
      with:
        context: .
        file: Dockerfile.distroless
        push: false
        load: true
        tags: local/researcharr:distroless

    - name: Run Trivy scan on distroless image
      run: |
        docker run --rm -v "${{ github.workspace }}":/workspace -w /workspace aquasec/trivy:latest image --format json -o build/artifacts/trivy-report-distroless.json local/researcharr:distroless || true

    - name: Upload Trivy JSON artifact
      uses: actions/upload-artifact@v4
      with:
        name: trivy-report-distroless
        path: build/artifacts/trivy-report-distroless.json

    - name: Prepare minimal config for smoke-test
      run: |
        mkdir -p build/smoke-config
        cp config.example.yml build/smoke-config/config.yml || true

    - name: Run distroless smoke-test (health endpoint + basic acceptance)
      id: smoke_test
      continue-on-error: true
      run: |
        set -euo pipefail
        CONTAINER_NAME=smoke_test_instance
        mkdir -p build/smoke-logs
        docker run --rm -d --name ${CONTAINER_NAME} -v "${{ github.workspace }}/build/smoke-config":/config -e CONFIG_PATH=/config/config.yml -p 2929:2929 local/researcharr:distroless || true
        # Wait up to 60s for the health endpoint and assert JSON keys
        HEALTH_OK=0
        for i in $(seq 1 60); do
          OUTPUT=$(curl -sS -f http://127.0.0.1:2929/health 2>/dev/null || true)
          if [ -n "$OUTPUT" ]; then
            if echo "$OUTPUT" | jq -e '.status and .config and .db' >/dev/null 2>&1; then
              echo "smoke-test: health ok and JSON shape validated"
              HEALTH_OK=1
              break
            else
              echo "smoke-test: health returned but JSON missing expected keys; output=$OUTPUT"
            fi
          fi
          sleep 1
        done
        if [ "$HEALTH_OK" -ne 1 ]; then
          echo "smoke-test: failed to validate health endpoint"
          docker logs ${CONTAINER_NAME} > build/smoke-logs/${CONTAINER_NAME}.log 2>&1 || true
          tar -czf build/smoke-logs.tar.gz -C build smoke-logs || true
          docker stop ${CONTAINER_NAME} || true
          exit 1
        fi
        docker stop ${CONTAINER_NAME} || true

    - name: Upload smoke-test logs (distroless)
      if: steps.smoke_test.outcome == 'failure'
      uses: actions/upload-artifact@v4
      with:
        name: smoke-logs-distroless
        path: build/smoke-logs.tar.gz

    - name: Compute VERSION
      id: version
      run: |
        if [[ "${GITHUB_REF}" =~ refs/tags/(.*) ]]; then
          echo "VERSION=${BASH_REMATCH[1]}" >> $GITHUB_ENV
        else
          echo "VERSION=0.0.0-alpha.${GITHUB_RUN_ID}" >> $GITHUB_ENV
        fi

    - name: Log in to GHCR
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/development' || startsWith(github.ref, 'refs/tags/')
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Tag and push distroless image to GHCR (main/development/tags only)
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/development' || startsWith(github.ref, 'refs/tags/')
      run: |
        docker tag local/researcharr:distroless ghcr.io/${{ github.repository }}:${{ env.VERSION }}-distroless
        docker tag local/researcharr:distroless ghcr.io/${{ github.repository }}:distroless
        docker push ghcr.io/${{ github.repository }}:${{ env.VERSION }}-distroless
        docker push ghcr.io/${{ github.repository }}:distroless

    - name: Publish dev tag (development branch only)
      if: github.ref == 'refs/heads/development'
      run: |
        docker tag local/researcharr:distroless ghcr.io/${{ github.repository }}:dev-${{ github.run_id }}
        docker push ghcr.io/${{ github.repository }}:dev-${{ github.run_id }}
