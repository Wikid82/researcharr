CI and Development

This page outlines the development workflow, continuous integration (CI) checks, and local developer recommendations for working on researcharr.

Repository CI

- CI runs on every push and every pull request. There are workflows at the repository root and inside `researcharr/.github/workflows/`.
- Checks performed in CI:
  - flake8 (style and simple lint checks)
  - black (formatting) — check-only mode in CI
  - isort (import sorting) — check-only mode in CI, configured to use Black's profile via `researcharr/.isort.cfg`
  - mypy (type checking) where configured
  - pytest (test suite)
- CI uses pip caching to speed up dependency installs. This keeps iteration fast for contributors.

Pre-commit and local checks

We strongly recommend installing and running `pre-commit` locally. The repository root contains `.pre-commit-config.yaml` with hooks for Black, isort, flake8, and other quality checks.

Install and enable pre-commit:

```bash
pip install pre-commit
pre-commit install
pre-commit run --all-files
```

Preview site and link checks

- Branch previews: For non-`main` branches a preview of `docs/` will be published to:
  `https://wikid82.github.io/researcharr/previews/<branch>/` (generated by CI on push).
- Link checks: PRs targeting `development` or `main` run a docs link-checker which validates internal/external links and reports failures on the PR.

Formatting and ordering (local developer flow)

Before committing or opening a PR, run the auto-fixers locally to match CI expectations:

```bash
isort --profile=black .
black .
```

Run tests:

```bash
python -m pytest tests/
```

Run the supplied developer command (if present):

`researcharr/tests/commands/run_tests.yml` contains the recommended command used by some CI runners and contributors:

```text
isort --profile=black . && black . && python -m pytest tests/
```

Notes on failing CI

- If CI reports `isort` or `black` failures, run the auto-fixers locally, commit, and push the changes.
- If `flake8` reports style issues, follow the flake8 messages. Many issues are resolved by running the formatters.

Branching and PRs

- Create feature branches for larger changes. Keep PRs small and focused where possible.
- CI will run on the PR; address any style/type/test failures before requesting final review.

Docker publishing & branch images

- After CI completes successfully for a push, the repository will automatically build and publish a Docker image tagged with the branch name to GitHub Container Registry. This lets contributors push branch images for QA.
- Example tags:
  - `ghcr.io/wikid82/researcharr:<branch>`
  - `ghcr.io/wikid82/researcharr:branch-<branch>`
- Special tags: merges to `development` and `main` will also publish `:development` and `:latest` tags respectively.

How to pull a branch image:

```bash
docker pull ghcr.io/wikid82/researcharr:plugins
docker run --rm -v /path/to/config:/config -p 2929:2929 ghcr.io/wikid82/researcharr:plugins
```

Security and housekeeping

- The publisher checks that CI passed and the upstream event was a push; PRs from forks do not publish images.
- Branch images can accumulate in GHCR. Consider a cleanup policy or retention strategy (we can add a scheduled cleanup job if desired).

Contact and help

If you're stuck, open an issue or ask in the PR discussion. Include the failing CI log snippets and the output of `pre-commit run --all-files` if applicable.
