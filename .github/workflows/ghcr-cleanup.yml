---
name: GHCR cleanup

on:
  schedule:
    - cron: "0 3 * * 0"  # every Sunday at 03:00 UTC
  workflow_dispatch:
    inputs:
      days:
        description: "Retention days (integer)"
        required: false
        default: "90"
      dry_run:
        description: "If true, will not delete (default true)"
        required: false
        default: "true"

permissions:
  packages: write
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5

      - name: Set up Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c  # v6
        with:
          python-version: "3.14"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run GHCR cleanup (dry-run by default)
        id: run_cleanup
        env:
          # Use the built-in GITHUB_TOKEN by default (repo permissions set above
          # include `packages: write`). If you prefer a personal access token,
          # create a repository secret named `GHCR_PAT` and set the value here
          # to `secrets.GHCR_PAT` instead.
          GHCR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name || github.repository }}
          DAYS: ${{ github.event.inputs.days || github.event.inputs.days || '90' }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'true' }}
          JSON_REPORT: ghcr_cleanup_report.json
        run: |
          python .github/scripts/ghcr_cleanup.py --json-report $JSON_REPORT --days $DAYS $( [ "$DRY_RUN" = "true" ] && echo --dry-run || echo --no-dry-run )

      - name: Upload report artifact
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5
        with:
          name: ghcr-cleanup-report
          path: ghcr_cleanup_report.json
