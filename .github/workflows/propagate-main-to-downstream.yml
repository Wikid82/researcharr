name: Propagate main to downstream

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  create-prs:
    runs-on: ubuntu-latest
    steps:
      - name: Create PRs from main into downstream branches
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const head = context.ref.replace('refs/heads/', '');
            // Configure downstream branches you want to forward changes to
            const downstreams = ['development'];

            for (const base of downstreams) {
              core.info(`Checking for existing open PRs from ${head} -> ${base}`);
              const { data: prs } = await github.rest.pulls.list({
                owner,
                repo,
                state: 'open',
                head: `${owner}:${head}`,
                base,
              });

              if (prs.length > 0) {
                core.info(`Open PR already exists: ${prs[0].html_url}`);
                continue;
              }

              const title = `chore(ci): propagate ${head} -> ${base}`;
              const body = `This is an automated PR created by CI to propagate changes from **${head}** into **${base}**.\n\nTriggered by commit: ${context.sha}`;

              try {
                const { data: pr } = await github.rest.pulls.create({
                  owner,
                  repo,
                  title,
                  head,
                  base,
                  body,
                });
                core.info(`Created PR: ${pr.html_url}`);
              } catch (err) {
                core.warning(`Failed to create PR ${head} -> ${base}: ${err}`);
              }
            }
